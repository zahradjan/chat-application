{"ast":null,"code":"'use strict';\n\nconst Store = require('orbit-db-store');\n\nconst EventIndex = require('./EventIndex'); // TODO: generalize the Iterator functions and spin to its own module\n\n\nclass EventStore extends Store {\n  constructor(ipfs, id, dbname) {\n    let options = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};\n    if (options.Index === undefined) Object.assign(options, {\n      Index: EventIndex\n    });\n    super(ipfs, id, dbname, options);\n    this._type = 'eventlog';\n    this.events.on(\"log.op.ADD\", (address, hash, payload) => {\n      this.events.emit(\"db.append\", payload.value);\n    });\n  }\n\n  add(data) {\n    let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    return this._addOperation({\n      op: 'ADD',\n      key: null,\n      value: data\n    }, options);\n  }\n\n  get(hash) {\n    return this.iterator({\n      gte: hash,\n      limit: 1\n    }).collect()[0];\n  }\n\n  iterator(options) {\n    const messages = this._query(options);\n\n    let currentIndex = 0;\n    let iterator = {\n      [Symbol.iterator]() {\n        return this;\n      },\n\n      next() {\n        let item = {\n          value: null,\n          done: true\n        };\n\n        if (currentIndex < messages.length) {\n          item = {\n            value: messages[currentIndex],\n            done: false\n          };\n          currentIndex++;\n        }\n\n        return item;\n      },\n\n      collect: () => messages\n    };\n    return iterator;\n  }\n\n  _query(opts) {\n    if (!opts) opts = {};\n    const amount = opts.limit ? opts.limit > -1 ? opts.limit : this._index.get().length : 1; // Return 1 if no limit is provided\n\n    const events = this._index.get().slice();\n\n    let result = [];\n\n    if (opts.gt || opts.gte) {\n      // Greater than case\n      result = this._read(events, opts.gt ? opts.gt : opts.gte, amount, !!opts.gte);\n    } else {\n      // Lower than and lastN case, search latest first by reversing the sequence\n      result = this._read(events.reverse(), opts.lt ? opts.lt : opts.lte, amount, opts.lte || !opts.lt).reverse();\n    }\n\n    if (opts.reverse) {\n      result.reverse();\n    }\n\n    return result;\n  }\n\n  _read(ops, hash, amount, inclusive) {\n    // Find the index of the gt/lt hash, or start from the beginning of the array if not found\n    const index = ops.map(e => e.hash).indexOf(hash);\n    let startIndex = Math.max(index, 0); // If gte/lte is set, we include the given hash, if not, start from the next element\n\n    startIndex += inclusive ? 0 : 1; // Slice the array to its requested size\n\n    const res = ops.slice(startIndex).slice(0, amount);\n    return res;\n  }\n\n}\n\nmodule.exports = EventStore;","map":{"version":3,"names":["Store","require","EventIndex","EventStore","constructor","ipfs","id","dbname","options","Index","undefined","Object","assign","_type","events","on","address","hash","payload","emit","value","add","data","_addOperation","op","key","get","iterator","gte","limit","collect","messages","_query","currentIndex","Symbol","next","item","done","length","opts","amount","_index","slice","result","gt","_read","reverse","lt","lte","ops","inclusive","index","map","e","indexOf","startIndex","Math","max","res","module","exports"],"sources":["C:/Users/zajan/GitHub/chatApplication/node_modules/orbit-db-eventstore/src/EventStore.js"],"sourcesContent":["'use strict'\n\nconst Store = require('orbit-db-store')\nconst EventIndex = require('./EventIndex')\n\n// TODO: generalize the Iterator functions and spin to its own module\n\nclass EventStore extends Store {\n  constructor (ipfs, id, dbname, options = {}) {\n    if (options.Index === undefined) Object.assign(options, { Index: EventIndex })\n    super(ipfs, id, dbname, options)\n    this._type = 'eventlog';\n    this.events.on(\"log.op.ADD\", (address, hash, payload) => {\n      this.events.emit(\"db.append\", payload.value)\n    })\n  }\n\n  add (data, options = {}) {\n    return this._addOperation({\n      op: 'ADD',\n      key: null,\n      value: data\n    }, options)\n  }\n\n  get (hash) {\n    return this.iterator({ gte: hash, limit: 1 }).collect()[0]\n  }\n  iterator (options) {\n    const messages = this._query(options)\n    let currentIndex = 0\n    let iterator = {\n      [Symbol.iterator] () {\n        return this\n      },\n      next () {\n        let item = { value: null, done: true }\n        if (currentIndex < messages.length) {\n          item = { value: messages[currentIndex], done: false }\n          currentIndex++\n        }\n        return item\n      },\n      collect: () => messages\n    }\n\n    return iterator\n  }\n\n  _query (opts) {\n    if (!opts) opts = {}\n\n    const amount = opts.limit ? (opts.limit > -1 ? opts.limit : this._index.get().length) : 1 // Return 1 if no limit is provided\n    const events = this._index.get().slice()\n    let result = []\n\n    if (opts.gt || opts.gte) {\n      // Greater than case\n      result = this._read(events, opts.gt ? opts.gt : opts.gte, amount, !!opts.gte)\n    } else {\n      // Lower than and lastN case, search latest first by reversing the sequence\n      result = this._read(events.reverse(), opts.lt ? opts.lt : opts.lte, amount, opts.lte || !opts.lt).reverse()\n    }\n    \n    if (opts.reverse) {\n      result.reverse()\n    }\n\n    return result\n  }\n\n  _read (ops, hash, amount, inclusive) {\n    // Find the index of the gt/lt hash, or start from the beginning of the array if not found\n    const index = ops.map((e) => e.hash).indexOf(hash)\n    let startIndex = Math.max(index, 0)\n    // If gte/lte is set, we include the given hash, if not, start from the next element\n    startIndex += inclusive ? 0 : 1\n    // Slice the array to its requested size\n    const res = ops.slice(startIndex).slice(0, amount)\n    return res\n  }\n}\n\nmodule.exports = EventStore\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}