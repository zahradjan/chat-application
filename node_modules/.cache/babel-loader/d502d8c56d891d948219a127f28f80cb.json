{"ast":null,"code":"'use strict';\n\nconst keysPBM = require('./keys');\n\nrequire('node-forge/lib/asn1');\n\nrequire('node-forge/lib/pbe');\n\nconst forge = require('node-forge/lib/forge');\n\nconst errcode = require('err-code');\n\nconst {\n  fromString: uint8ArrayFromString\n} = require('uint8arrays/from-string');\n\nconst importer = require('./importer');\n\nconst supportedKeys = {\n  rsa: require('./rsa-class'),\n  ed25519: require('./ed25519-class'),\n  secp256k1: require('./secp256k1-class')(keysPBM, require('../random-bytes'))\n};\nconst ErrMissingSecp256K1 = {\n  message: 'secp256k1 support requires libp2p-crypto-secp256k1 package',\n  code: 'ERR_MISSING_PACKAGE'\n};\n\nfunction typeToKey(type) {\n  const key = supportedKeys[type.toLowerCase()];\n\n  if (!key) {\n    const supported = Object.keys(supportedKeys).join(' / ');\n    throw errcode(new Error(`invalid or unsupported key type ${type}. Must be ${supported}`), 'ERR_UNSUPPORTED_KEY_TYPE');\n  }\n\n  return key;\n} // Generates a keypair of the given type and bitsize\n\n\nconst generateKeyPair = async (type, bits) => {\n  // eslint-disable-line require-await\n  return typeToKey(type).generateKeyPair(bits);\n}; // Generates a keypair of the given type and bitsize\n// seed is a 32 byte uint8array\n\n\nconst generateKeyPairFromSeed = async (type, seed, bits) => {\n  // eslint-disable-line require-await\n  const key = typeToKey(type);\n\n  if (type.toLowerCase() !== 'ed25519') {\n    throw errcode(new Error('Seed key derivation is unimplemented for RSA or secp256k1'), 'ERR_UNSUPPORTED_KEY_DERIVATION_TYPE');\n  }\n\n  return key.generateKeyPairFromSeed(seed, bits);\n}; // Converts a protobuf serialized public key into its\n// representative object\n\n\nconst unmarshalPublicKey = buf => {\n  const decoded = keysPBM.PublicKey.decode(buf);\n  const data = decoded.Data;\n\n  switch (decoded.Type) {\n    case keysPBM.KeyType.RSA:\n      return supportedKeys.rsa.unmarshalRsaPublicKey(data);\n\n    case keysPBM.KeyType.Ed25519:\n      return supportedKeys.ed25519.unmarshalEd25519PublicKey(data);\n\n    case keysPBM.KeyType.Secp256k1:\n      if (supportedKeys.secp256k1) {\n        return supportedKeys.secp256k1.unmarshalSecp256k1PublicKey(data);\n      } else {\n        throw errcode(new Error(ErrMissingSecp256K1.message), ErrMissingSecp256K1.code);\n      }\n\n    default:\n      typeToKey(decoded.Type);\n    // throws because type is not supported\n  }\n}; // Converts a public key object into a protobuf serialized public key\n\n\nconst marshalPublicKey = (key, type) => {\n  type = (type || 'rsa').toLowerCase();\n  typeToKey(type); // check type\n\n  return key.bytes;\n}; // Converts a protobuf serialized private key into its\n// representative object\n\n\nconst unmarshalPrivateKey = async buf => {\n  // eslint-disable-line require-await\n  const decoded = keysPBM.PrivateKey.decode(buf);\n  const data = decoded.Data;\n\n  switch (decoded.Type) {\n    case keysPBM.KeyType.RSA:\n      return supportedKeys.rsa.unmarshalRsaPrivateKey(data);\n\n    case keysPBM.KeyType.Ed25519:\n      return supportedKeys.ed25519.unmarshalEd25519PrivateKey(data);\n\n    case keysPBM.KeyType.Secp256k1:\n      if (supportedKeys.secp256k1) {\n        return supportedKeys.secp256k1.unmarshalSecp256k1PrivateKey(data);\n      } else {\n        throw errcode(new Error(ErrMissingSecp256K1.message), ErrMissingSecp256K1.code);\n      }\n\n    default:\n      typeToKey(decoded.Type);\n    // throws because type is not supported\n  }\n}; // Converts a private key object into a protobuf serialized private key\n\n\nconst marshalPrivateKey = (key, type) => {\n  type = (type || 'rsa').toLowerCase();\n  typeToKey(type); // check type\n\n  return key.bytes;\n};\n/**\n *\n * @param {string} encryptedKey\n * @param {string} password\n */\n\n\nconst importKey = async (encryptedKey, password) => {\n  // eslint-disable-line require-await\n  try {\n    const key = await importer.import(encryptedKey, password);\n    return unmarshalPrivateKey(key);\n  } catch (_) {// Ignore and try the old pem decrypt\n  } // Only rsa supports pem right now\n\n\n  const key = forge.pki.decryptRsaPrivateKey(encryptedKey, password);\n\n  if (key === null) {\n    throw errcode(new Error('Cannot read the key, most likely the password is wrong or not a RSA key'), 'ERR_CANNOT_DECRYPT_PEM');\n  }\n\n  let der = forge.asn1.toDer(forge.pki.privateKeyToAsn1(key));\n  der = uint8ArrayFromString(der.getBytes(), 'ascii');\n  return supportedKeys.rsa.unmarshalRsaPrivateKey(der);\n};\n\nmodule.exports = {\n  supportedKeys,\n  keysPBM,\n  keyStretcher: require('./key-stretcher'),\n  generateEphemeralKeyPair: require('./ephemeral-keys'),\n  generateKeyPair,\n  generateKeyPairFromSeed,\n  unmarshalPublicKey,\n  marshalPublicKey,\n  unmarshalPrivateKey,\n  marshalPrivateKey,\n  import: importKey\n};","map":{"version":3,"names":["keysPBM","require","forge","errcode","fromString","uint8ArrayFromString","importer","supportedKeys","rsa","ed25519","secp256k1","ErrMissingSecp256K1","message","code","typeToKey","type","key","toLowerCase","supported","Object","keys","join","Error","generateKeyPair","bits","generateKeyPairFromSeed","seed","unmarshalPublicKey","buf","decoded","PublicKey","decode","data","Data","Type","KeyType","RSA","unmarshalRsaPublicKey","Ed25519","unmarshalEd25519PublicKey","Secp256k1","unmarshalSecp256k1PublicKey","marshalPublicKey","bytes","unmarshalPrivateKey","PrivateKey","unmarshalRsaPrivateKey","unmarshalEd25519PrivateKey","unmarshalSecp256k1PrivateKey","marshalPrivateKey","importKey","encryptedKey","password","import","_","pki","decryptRsaPrivateKey","der","asn1","toDer","privateKeyToAsn1","getBytes","module","exports","keyStretcher","generateEphemeralKeyPair"],"sources":["C:/Users/zajan/GitHub/chatApplication/node_modules/libp2p-crypto/src/keys/index.js"],"sourcesContent":["'use strict'\n\nconst keysPBM = require('./keys')\nrequire('node-forge/lib/asn1')\nrequire('node-forge/lib/pbe')\nconst forge = require('node-forge/lib/forge')\nconst errcode = require('err-code')\nconst { fromString: uint8ArrayFromString } = require('uint8arrays/from-string')\n\nconst importer = require('./importer')\n\nconst supportedKeys = {\n  rsa: require('./rsa-class'),\n  ed25519: require('./ed25519-class'),\n  secp256k1: require('./secp256k1-class')(keysPBM, require('../random-bytes'))\n}\n\nconst ErrMissingSecp256K1 = {\n  message: 'secp256k1 support requires libp2p-crypto-secp256k1 package',\n  code: 'ERR_MISSING_PACKAGE'\n}\n\nfunction typeToKey (type) {\n  const key = supportedKeys[type.toLowerCase()]\n  if (!key) {\n    const supported = Object.keys(supportedKeys).join(' / ')\n    throw errcode(new Error(`invalid or unsupported key type ${type}. Must be ${supported}`), 'ERR_UNSUPPORTED_KEY_TYPE')\n  }\n  return key\n}\n\n// Generates a keypair of the given type and bitsize\nconst generateKeyPair = async (type, bits) => { // eslint-disable-line require-await\n  return typeToKey(type).generateKeyPair(bits)\n}\n\n// Generates a keypair of the given type and bitsize\n// seed is a 32 byte uint8array\nconst generateKeyPairFromSeed = async (type, seed, bits) => { // eslint-disable-line require-await\n  const key = typeToKey(type)\n  if (type.toLowerCase() !== 'ed25519') {\n    throw errcode(new Error('Seed key derivation is unimplemented for RSA or secp256k1'), 'ERR_UNSUPPORTED_KEY_DERIVATION_TYPE')\n  }\n  return key.generateKeyPairFromSeed(seed, bits)\n}\n\n// Converts a protobuf serialized public key into its\n// representative object\nconst unmarshalPublicKey = (buf) => {\n  const decoded = keysPBM.PublicKey.decode(buf)\n  const data = decoded.Data\n\n  switch (decoded.Type) {\n    case keysPBM.KeyType.RSA:\n      return supportedKeys.rsa.unmarshalRsaPublicKey(data)\n    case keysPBM.KeyType.Ed25519:\n      return supportedKeys.ed25519.unmarshalEd25519PublicKey(data)\n    case keysPBM.KeyType.Secp256k1:\n      if (supportedKeys.secp256k1) {\n        return supportedKeys.secp256k1.unmarshalSecp256k1PublicKey(data)\n      } else {\n        throw errcode(new Error(ErrMissingSecp256K1.message), ErrMissingSecp256K1.code)\n      }\n    default:\n      typeToKey(decoded.Type) // throws because type is not supported\n  }\n}\n\n// Converts a public key object into a protobuf serialized public key\nconst marshalPublicKey = (key, type) => {\n  type = (type || 'rsa').toLowerCase()\n  typeToKey(type) // check type\n  return key.bytes\n}\n\n// Converts a protobuf serialized private key into its\n// representative object\nconst unmarshalPrivateKey = async (buf) => { // eslint-disable-line require-await\n  const decoded = keysPBM.PrivateKey.decode(buf)\n  const data = decoded.Data\n\n  switch (decoded.Type) {\n    case keysPBM.KeyType.RSA:\n      return supportedKeys.rsa.unmarshalRsaPrivateKey(data)\n    case keysPBM.KeyType.Ed25519:\n      return supportedKeys.ed25519.unmarshalEd25519PrivateKey(data)\n    case keysPBM.KeyType.Secp256k1:\n      if (supportedKeys.secp256k1) {\n        return supportedKeys.secp256k1.unmarshalSecp256k1PrivateKey(data)\n      } else {\n        throw errcode(new Error(ErrMissingSecp256K1.message), ErrMissingSecp256K1.code)\n      }\n    default:\n      typeToKey(decoded.Type) // throws because type is not supported\n  }\n}\n\n// Converts a private key object into a protobuf serialized private key\nconst marshalPrivateKey = (key, type) => {\n  type = (type || 'rsa').toLowerCase()\n  typeToKey(type) // check type\n  return key.bytes\n}\n\n/**\n *\n * @param {string} encryptedKey\n * @param {string} password\n */\nconst importKey = async (encryptedKey, password) => { // eslint-disable-line require-await\n  try {\n    const key = await importer.import(encryptedKey, password)\n    return unmarshalPrivateKey(key)\n  } catch (_) {\n    // Ignore and try the old pem decrypt\n  }\n\n  // Only rsa supports pem right now\n  const key = forge.pki.decryptRsaPrivateKey(encryptedKey, password)\n  if (key === null) {\n    throw errcode(new Error('Cannot read the key, most likely the password is wrong or not a RSA key'), 'ERR_CANNOT_DECRYPT_PEM')\n  }\n  let der = forge.asn1.toDer(forge.pki.privateKeyToAsn1(key))\n  der = uint8ArrayFromString(der.getBytes(), 'ascii')\n  return supportedKeys.rsa.unmarshalRsaPrivateKey(der)\n}\n\nmodule.exports = {\n  supportedKeys,\n  keysPBM,\n  keyStretcher: require('./key-stretcher'),\n  generateEphemeralKeyPair: require('./ephemeral-keys'),\n  generateKeyPair,\n  generateKeyPairFromSeed,\n  unmarshalPublicKey,\n  marshalPublicKey,\n  unmarshalPrivateKey,\n  marshalPrivateKey,\n  import: importKey\n}\n"],"mappings":"AAAA;;AAEA,MAAMA,OAAO,GAAGC,OAAO,CAAC,QAAD,CAAvB;;AACAA,OAAO,CAAC,qBAAD,CAAP;;AACAA,OAAO,CAAC,oBAAD,CAAP;;AACA,MAAMC,KAAK,GAAGD,OAAO,CAAC,sBAAD,CAArB;;AACA,MAAME,OAAO,GAAGF,OAAO,CAAC,UAAD,CAAvB;;AACA,MAAM;EAAEG,UAAU,EAAEC;AAAd,IAAuCJ,OAAO,CAAC,yBAAD,CAApD;;AAEA,MAAMK,QAAQ,GAAGL,OAAO,CAAC,YAAD,CAAxB;;AAEA,MAAMM,aAAa,GAAG;EACpBC,GAAG,EAAEP,OAAO,CAAC,aAAD,CADQ;EAEpBQ,OAAO,EAAER,OAAO,CAAC,iBAAD,CAFI;EAGpBS,SAAS,EAAET,OAAO,CAAC,mBAAD,CAAP,CAA6BD,OAA7B,EAAsCC,OAAO,CAAC,iBAAD,CAA7C;AAHS,CAAtB;AAMA,MAAMU,mBAAmB,GAAG;EAC1BC,OAAO,EAAE,4DADiB;EAE1BC,IAAI,EAAE;AAFoB,CAA5B;;AAKA,SAASC,SAAT,CAAoBC,IAApB,EAA0B;EACxB,MAAMC,GAAG,GAAGT,aAAa,CAACQ,IAAI,CAACE,WAAL,EAAD,CAAzB;;EACA,IAAI,CAACD,GAAL,EAAU;IACR,MAAME,SAAS,GAAGC,MAAM,CAACC,IAAP,CAAYb,aAAZ,EAA2Bc,IAA3B,CAAgC,KAAhC,CAAlB;IACA,MAAMlB,OAAO,CAAC,IAAImB,KAAJ,CAAW,mCAAkCP,IAAK,aAAYG,SAAU,EAAxE,CAAD,EAA6E,0BAA7E,CAAb;EACD;;EACD,OAAOF,GAAP;AACD,C,CAED;;;AACA,MAAMO,eAAe,GAAG,OAAOR,IAAP,EAAaS,IAAb,KAAsB;EAAE;EAC9C,OAAOV,SAAS,CAACC,IAAD,CAAT,CAAgBQ,eAAhB,CAAgCC,IAAhC,CAAP;AACD,CAFD,C,CAIA;AACA;;;AACA,MAAMC,uBAAuB,GAAG,OAAOV,IAAP,EAAaW,IAAb,EAAmBF,IAAnB,KAA4B;EAAE;EAC5D,MAAMR,GAAG,GAAGF,SAAS,CAACC,IAAD,CAArB;;EACA,IAAIA,IAAI,CAACE,WAAL,OAAuB,SAA3B,EAAsC;IACpC,MAAMd,OAAO,CAAC,IAAImB,KAAJ,CAAU,2DAAV,CAAD,EAAyE,qCAAzE,CAAb;EACD;;EACD,OAAON,GAAG,CAACS,uBAAJ,CAA4BC,IAA5B,EAAkCF,IAAlC,CAAP;AACD,CAND,C,CAQA;AACA;;;AACA,MAAMG,kBAAkB,GAAIC,GAAD,IAAS;EAClC,MAAMC,OAAO,GAAG7B,OAAO,CAAC8B,SAAR,CAAkBC,MAAlB,CAAyBH,GAAzB,CAAhB;EACA,MAAMI,IAAI,GAAGH,OAAO,CAACI,IAArB;;EAEA,QAAQJ,OAAO,CAACK,IAAhB;IACE,KAAKlC,OAAO,CAACmC,OAAR,CAAgBC,GAArB;MACE,OAAO7B,aAAa,CAACC,GAAd,CAAkB6B,qBAAlB,CAAwCL,IAAxC,CAAP;;IACF,KAAKhC,OAAO,CAACmC,OAAR,CAAgBG,OAArB;MACE,OAAO/B,aAAa,CAACE,OAAd,CAAsB8B,yBAAtB,CAAgDP,IAAhD,CAAP;;IACF,KAAKhC,OAAO,CAACmC,OAAR,CAAgBK,SAArB;MACE,IAAIjC,aAAa,CAACG,SAAlB,EAA6B;QAC3B,OAAOH,aAAa,CAACG,SAAd,CAAwB+B,2BAAxB,CAAoDT,IAApD,CAAP;MACD,CAFD,MAEO;QACL,MAAM7B,OAAO,CAAC,IAAImB,KAAJ,CAAUX,mBAAmB,CAACC,OAA9B,CAAD,EAAyCD,mBAAmB,CAACE,IAA7D,CAAb;MACD;;IACH;MACEC,SAAS,CAACe,OAAO,CAACK,IAAT,CAAT;IAAwB;EAZ5B;AAcD,CAlBD,C,CAoBA;;;AACA,MAAMQ,gBAAgB,GAAG,CAAC1B,GAAD,EAAMD,IAAN,KAAe;EACtCA,IAAI,GAAG,CAACA,IAAI,IAAI,KAAT,EAAgBE,WAAhB,EAAP;EACAH,SAAS,CAACC,IAAD,CAAT,CAFsC,CAEtB;;EAChB,OAAOC,GAAG,CAAC2B,KAAX;AACD,CAJD,C,CAMA;AACA;;;AACA,MAAMC,mBAAmB,GAAG,MAAOhB,GAAP,IAAe;EAAE;EAC3C,MAAMC,OAAO,GAAG7B,OAAO,CAAC6C,UAAR,CAAmBd,MAAnB,CAA0BH,GAA1B,CAAhB;EACA,MAAMI,IAAI,GAAGH,OAAO,CAACI,IAArB;;EAEA,QAAQJ,OAAO,CAACK,IAAhB;IACE,KAAKlC,OAAO,CAACmC,OAAR,CAAgBC,GAArB;MACE,OAAO7B,aAAa,CAACC,GAAd,CAAkBsC,sBAAlB,CAAyCd,IAAzC,CAAP;;IACF,KAAKhC,OAAO,CAACmC,OAAR,CAAgBG,OAArB;MACE,OAAO/B,aAAa,CAACE,OAAd,CAAsBsC,0BAAtB,CAAiDf,IAAjD,CAAP;;IACF,KAAKhC,OAAO,CAACmC,OAAR,CAAgBK,SAArB;MACE,IAAIjC,aAAa,CAACG,SAAlB,EAA6B;QAC3B,OAAOH,aAAa,CAACG,SAAd,CAAwBsC,4BAAxB,CAAqDhB,IAArD,CAAP;MACD,CAFD,MAEO;QACL,MAAM7B,OAAO,CAAC,IAAImB,KAAJ,CAAUX,mBAAmB,CAACC,OAA9B,CAAD,EAAyCD,mBAAmB,CAACE,IAA7D,CAAb;MACD;;IACH;MACEC,SAAS,CAACe,OAAO,CAACK,IAAT,CAAT;IAAwB;EAZ5B;AAcD,CAlBD,C,CAoBA;;;AACA,MAAMe,iBAAiB,GAAG,CAACjC,GAAD,EAAMD,IAAN,KAAe;EACvCA,IAAI,GAAG,CAACA,IAAI,IAAI,KAAT,EAAgBE,WAAhB,EAAP;EACAH,SAAS,CAACC,IAAD,CAAT,CAFuC,CAEvB;;EAChB,OAAOC,GAAG,CAAC2B,KAAX;AACD,CAJD;AAMA;AACA;AACA;AACA;AACA;;;AACA,MAAMO,SAAS,GAAG,OAAOC,YAAP,EAAqBC,QAArB,KAAkC;EAAE;EACpD,IAAI;IACF,MAAMpC,GAAG,GAAG,MAAMV,QAAQ,CAAC+C,MAAT,CAAgBF,YAAhB,EAA8BC,QAA9B,CAAlB;IACA,OAAOR,mBAAmB,CAAC5B,GAAD,CAA1B;EACD,CAHD,CAGE,OAAOsC,CAAP,EAAU,CACV;EACD,CANiD,CAQlD;;;EACA,MAAMtC,GAAG,GAAGd,KAAK,CAACqD,GAAN,CAAUC,oBAAV,CAA+BL,YAA/B,EAA6CC,QAA7C,CAAZ;;EACA,IAAIpC,GAAG,KAAK,IAAZ,EAAkB;IAChB,MAAMb,OAAO,CAAC,IAAImB,KAAJ,CAAU,yEAAV,CAAD,EAAuF,wBAAvF,CAAb;EACD;;EACD,IAAImC,GAAG,GAAGvD,KAAK,CAACwD,IAAN,CAAWC,KAAX,CAAiBzD,KAAK,CAACqD,GAAN,CAAUK,gBAAV,CAA2B5C,GAA3B,CAAjB,CAAV;EACAyC,GAAG,GAAGpD,oBAAoB,CAACoD,GAAG,CAACI,QAAJ,EAAD,EAAiB,OAAjB,CAA1B;EACA,OAAOtD,aAAa,CAACC,GAAd,CAAkBsC,sBAAlB,CAAyCW,GAAzC,CAAP;AACD,CAhBD;;AAkBAK,MAAM,CAACC,OAAP,GAAiB;EACfxD,aADe;EAEfP,OAFe;EAGfgE,YAAY,EAAE/D,OAAO,CAAC,iBAAD,CAHN;EAIfgE,wBAAwB,EAAEhE,OAAO,CAAC,kBAAD,CAJlB;EAKfsB,eALe;EAMfE,uBANe;EAOfE,kBAPe;EAQfe,gBARe;EASfE,mBATe;EAUfK,iBAVe;EAWfI,MAAM,EAAEH;AAXO,CAAjB"},"metadata":{},"sourceType":"script"}