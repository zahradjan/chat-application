{"ast":null,"code":"'use strict';\n\nvar _regeneratorRuntime = require(\"C:/Users/zajan/GitHub/chatApplication/node_modules/@babel/runtime/helpers/regeneratorRuntime.js\").default;\n\nvar _slicedToArray = require(\"C:/Users/zajan/GitHub/chatApplication/node_modules/@babel/runtime/helpers/slicedToArray.js\").default;\n\nvar _asyncToGenerator = require(\"C:/Users/zajan/GitHub/chatApplication/node_modules/@babel/runtime/helpers/asyncToGenerator.js\").default;\n\nvar _require = require('libp2p-record'),\n    Record = _require.Record;\n\nvar errcode = require('err-code');\n\nvar Message = require('../../message');\n\nvar utils = require('../../utils');\n/**\n * @typedef {import('peer-id')} PeerId\n */\n\n/**\n * @param {import('../../index')} dht\n */\n\n\nmodule.exports = function (dht) {\n  var log = utils.logger(dht.peerId, 'rpc:get-value');\n  /**\n   * Process `GetValue` DHT messages.\n   *\n   * @param {PeerId} peerId\n   * @param {Message} msg\n   * @returns {Promise<Message>}\n   */\n\n  function getValue(_x, _x2) {\n    return _getValue.apply(this, arguments);\n  }\n\n  function _getValue() {\n    _getValue = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee(peerId, msg) {\n      var key, response, idFromKey, id, peerData, _yield$Promise$all, _yield$Promise$all2, record, closer;\n\n      return _regeneratorRuntime().wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              key = msg.key;\n              log('key: %b', key);\n\n              if (!(!key || key.length === 0)) {\n                _context.next = 4;\n                break;\n              }\n\n              throw errcode(new Error('Invalid key'), 'ERR_INVALID_KEY');\n\n            case 4:\n              response = new Message(Message.TYPES.GET_VALUE, key, msg.clusterLevel);\n\n              if (!utils.isPublicKeyKey(key)) {\n                _context.next = 13;\n                break;\n              }\n\n              log('is public key');\n              idFromKey = utils.fromPublicKeyKey(key);\n\n              if (dht._isSelf(idFromKey)) {\n                id = dht.peerId;\n              } else {\n                peerData = dht.peerStore.get(idFromKey);\n                id = peerData && peerData.id;\n              }\n\n              if (!(id && id.pubKey)) {\n                _context.next = 13;\n                break;\n              }\n\n              log('returning found public key');\n              response.record = new Record(key, id.pubKey.bytes);\n              return _context.abrupt(\"return\", response);\n\n            case 13:\n              _context.next = 15;\n              return Promise.all([dht._checkLocalDatastore(key), dht._betterPeersToQuery(msg, peerId)]);\n\n            case 15:\n              _yield$Promise$all = _context.sent;\n              _yield$Promise$all2 = _slicedToArray(_yield$Promise$all, 2);\n              record = _yield$Promise$all2[0];\n              closer = _yield$Promise$all2[1];\n\n              if (record) {\n                log('got record');\n                response.record = record;\n              }\n\n              if (closer.length > 0) {\n                log('got closer %s', closer.length);\n                response.closerPeers = closer;\n              }\n\n              return _context.abrupt(\"return\", response);\n\n            case 22:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n    return _getValue.apply(this, arguments);\n  }\n\n  return getValue;\n};","map":{"version":3,"names":["require","Record","errcode","Message","utils","module","exports","dht","log","logger","peerId","getValue","msg","key","length","Error","response","TYPES","GET_VALUE","clusterLevel","isPublicKeyKey","idFromKey","fromPublicKeyKey","_isSelf","id","peerData","peerStore","get","pubKey","record","bytes","Promise","all","_checkLocalDatastore","_betterPeersToQuery","closer","closerPeers"],"sources":["C:/Users/zajan/GitHub/chatApplication/node_modules/libp2p-kad-dht/src/rpc/handlers/get-value.js"],"sourcesContent":["'use strict'\n\nconst { Record } = require('libp2p-record')\n\nconst errcode = require('err-code')\n\nconst Message = require('../../message')\nconst utils = require('../../utils')\n\n/**\n * @typedef {import('peer-id')} PeerId\n */\n\n/**\n * @param {import('../../index')} dht\n */\nmodule.exports = (dht) => {\n  const log = utils.logger(dht.peerId, 'rpc:get-value')\n\n  /**\n   * Process `GetValue` DHT messages.\n   *\n   * @param {PeerId} peerId\n   * @param {Message} msg\n   * @returns {Promise<Message>}\n   */\n  async function getValue (peerId, msg) {\n    const key = msg.key\n\n    log('key: %b', key)\n\n    if (!key || key.length === 0) {\n      throw errcode(new Error('Invalid key'), 'ERR_INVALID_KEY')\n    }\n\n    const response = new Message(Message.TYPES.GET_VALUE, key, msg.clusterLevel)\n\n    if (utils.isPublicKeyKey(key)) {\n      log('is public key')\n      const idFromKey = utils.fromPublicKeyKey(key)\n      let id\n\n      if (dht._isSelf(idFromKey)) {\n        id = dht.peerId\n      } else {\n        const peerData = dht.peerStore.get(idFromKey)\n        id = peerData && peerData.id\n      }\n\n      if (id && id.pubKey) {\n        log('returning found public key')\n        response.record = new Record(key, id.pubKey.bytes)\n        return response\n      }\n    }\n\n    const [record, closer] = await Promise.all([\n      dht._checkLocalDatastore(key),\n      dht._betterPeersToQuery(msg, peerId)\n    ])\n\n    if (record) {\n      log('got record')\n      response.record = record\n    }\n\n    if (closer.length > 0) {\n      log('got closer %s', closer.length)\n      response.closerPeers = closer\n    }\n\n    return response\n  }\n\n  return getValue\n}\n"],"mappings":"AAAA;;;;;;;;AAEA,eAAmBA,OAAO,CAAC,eAAD,CAA1B;AAAA,IAAQC,MAAR,YAAQA,MAAR;;AAEA,IAAMC,OAAO,GAAGF,OAAO,CAAC,UAAD,CAAvB;;AAEA,IAAMG,OAAO,GAAGH,OAAO,CAAC,eAAD,CAAvB;;AACA,IAAMI,KAAK,GAAGJ,OAAO,CAAC,aAAD,CAArB;AAEA;AACA;AACA;;AAEA;AACA;AACA;;;AACAK,MAAM,CAACC,OAAP,GAAiB,UAACC,GAAD,EAAS;EACxB,IAAMC,GAAG,GAAGJ,KAAK,CAACK,MAAN,CAAaF,GAAG,CAACG,MAAjB,EAAyB,eAAzB,CAAZ;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;;EAT0B,SAUTC,QAVS;IAAA;EAAA;;EAAA;IAAA,uEAUxB,iBAAyBD,MAAzB,EAAiCE,GAAjC;MAAA;;MAAA;QAAA;UAAA;YAAA;cACQC,GADR,GACcD,GAAG,CAACC,GADlB;cAGEL,GAAG,CAAC,SAAD,EAAYK,GAAZ,CAAH;;cAHF,MAKM,CAACA,GAAD,IAAQA,GAAG,CAACC,MAAJ,KAAe,CAL7B;gBAAA;gBAAA;cAAA;;cAAA,MAMUZ,OAAO,CAAC,IAAIa,KAAJ,CAAU,aAAV,CAAD,EAA2B,iBAA3B,CANjB;;YAAA;cASQC,QATR,GASmB,IAAIb,OAAJ,CAAYA,OAAO,CAACc,KAAR,CAAcC,SAA1B,EAAqCL,GAArC,EAA0CD,GAAG,CAACO,YAA9C,CATnB;;cAAA,KAWMf,KAAK,CAACgB,cAAN,CAAqBP,GAArB,CAXN;gBAAA;gBAAA;cAAA;;cAYIL,GAAG,CAAC,eAAD,CAAH;cACMa,SAbV,GAasBjB,KAAK,CAACkB,gBAAN,CAAuBT,GAAvB,CAbtB;;cAgBI,IAAIN,GAAG,CAACgB,OAAJ,CAAYF,SAAZ,CAAJ,EAA4B;gBAC1BG,EAAE,GAAGjB,GAAG,CAACG,MAAT;cACD,CAFD,MAEO;gBACCe,QADD,GACYlB,GAAG,CAACmB,SAAJ,CAAcC,GAAd,CAAkBN,SAAlB,CADZ;gBAELG,EAAE,GAAGC,QAAQ,IAAIA,QAAQ,CAACD,EAA1B;cACD;;cArBL,MAuBQA,EAAE,IAAIA,EAAE,CAACI,MAvBjB;gBAAA;gBAAA;cAAA;;cAwBMpB,GAAG,CAAC,4BAAD,CAAH;cACAQ,QAAQ,CAACa,MAAT,GAAkB,IAAI5B,MAAJ,CAAWY,GAAX,EAAgBW,EAAE,CAACI,MAAH,CAAUE,KAA1B,CAAlB;cAzBN,iCA0Bad,QA1Bb;;YAAA;cAAA;cAAA,OA8BiCe,OAAO,CAACC,GAAR,CAAY,CACzCzB,GAAG,CAAC0B,oBAAJ,CAAyBpB,GAAzB,CADyC,EAEzCN,GAAG,CAAC2B,mBAAJ,CAAwBtB,GAAxB,EAA6BF,MAA7B,CAFyC,CAAZ,CA9BjC;;YAAA;cAAA;cAAA;cA8BSmB,MA9BT;cA8BiBM,MA9BjB;;cAmCE,IAAIN,MAAJ,EAAY;gBACVrB,GAAG,CAAC,YAAD,CAAH;gBACAQ,QAAQ,CAACa,MAAT,GAAkBA,MAAlB;cACD;;cAED,IAAIM,MAAM,CAACrB,MAAP,GAAgB,CAApB,EAAuB;gBACrBN,GAAG,CAAC,eAAD,EAAkB2B,MAAM,CAACrB,MAAzB,CAAH;gBACAE,QAAQ,CAACoB,WAAT,GAAuBD,MAAvB;cACD;;cA3CH,iCA6CSnB,QA7CT;;YAAA;YAAA;cAAA;UAAA;QAAA;MAAA;IAAA,CAVwB;IAAA;EAAA;;EA0DxB,OAAOL,QAAP;AACD,CA3DD"},"metadata":{},"sourceType":"script"}