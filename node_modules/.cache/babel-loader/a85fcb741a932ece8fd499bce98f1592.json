{"ast":null,"code":"/* global IDBKeyRange */\n'use strict';\n\nvar inherits = require('inherits');\n\nvar AbstractIterator = require('abstract-leveldown').AbstractIterator;\n\nvar ltgt = require('ltgt');\n\nvar mixedToBuffer = require('./util/mixed-to-buffer');\n\nvar setImmediate = require('./util/immediate');\n\nvar noop = function noop() {};\n\nmodule.exports = Iterator;\n\nfunction Iterator(db, location, options) {\n  AbstractIterator.call(this, db);\n  this._limit = options.limit;\n  this._count = 0;\n  this._callback = null;\n  this._cache = [];\n  this._completed = false;\n  this._aborted = false;\n  this._error = null;\n  this._transaction = null;\n  this._keyAsBuffer = options.keyAsBuffer;\n  this._valueAsBuffer = options.valueAsBuffer;\n\n  if (this._limit === 0) {\n    this._completed = true;\n    return;\n  }\n\n  try {\n    var keyRange = this.createKeyRange(options);\n  } catch (e) {\n    // The lower key is greater than the upper key.\n    // IndexedDB throws an error, but we'll just return 0 results.\n    this._completed = true;\n    return;\n  }\n\n  this.createIterator(location, keyRange, options.reverse);\n}\n\ninherits(Iterator, AbstractIterator);\n\nIterator.prototype.createKeyRange = function (options) {\n  var lower = ltgt.lowerBound(options);\n  var upper = ltgt.upperBound(options);\n  var lowerOpen = ltgt.lowerBoundExclusive(options);\n  var upperOpen = ltgt.upperBoundExclusive(options);\n\n  if (lower !== undefined && upper !== undefined) {\n    return IDBKeyRange.bound(lower, upper, lowerOpen, upperOpen);\n  } else if (lower !== undefined) {\n    return IDBKeyRange.lowerBound(lower, lowerOpen);\n  } else if (upper !== undefined) {\n    return IDBKeyRange.upperBound(upper, upperOpen);\n  } else {\n    return null;\n  }\n};\n\nIterator.prototype.createIterator = function (location, keyRange, reverse) {\n  var self = this;\n  var transaction = this.db.db.transaction([location], 'readonly');\n  var store = transaction.objectStore(location);\n  var req = store.openCursor(keyRange, reverse ? 'prev' : 'next');\n\n  req.onsuccess = function (ev) {\n    var cursor = ev.target.result;\n    if (cursor) self.onItem(cursor);\n  };\n\n  this._transaction = transaction; // If an error occurs (on the request), the transaction will abort.\n\n  transaction.onabort = function () {\n    self.onAbort(self._transaction.error || new Error('aborted by user'));\n  };\n\n  transaction.oncomplete = function () {\n    self.onComplete();\n  };\n};\n\nIterator.prototype.onItem = function (cursor) {\n  this._cache.push(cursor.key, cursor.value);\n\n  if (this._limit <= 0 || ++this._count < this._limit) {\n    cursor['continue']();\n  }\n\n  this.maybeNext();\n};\n\nIterator.prototype.onAbort = function (err) {\n  this._aborted = true;\n  this._error = err;\n  this.maybeNext();\n};\n\nIterator.prototype.onComplete = function () {\n  this._completed = true;\n  this.maybeNext();\n};\n\nIterator.prototype.maybeNext = function () {\n  if (this._callback) {\n    this._next(this._callback);\n\n    this._callback = null;\n  }\n};\n\nIterator.prototype._next = function (callback) {\n  if (this._aborted) {\n    // The error should be picked up by either next() or end().\n    var err = this._error;\n    this._error = null;\n    setImmediate(function () {\n      callback(err);\n    });\n  } else if (this._cache.length > 0) {\n    var key = this._cache.shift();\n\n    var value = this._cache.shift();\n\n    if (this._keyAsBuffer) key = mixedToBuffer(key);\n    if (this._valueAsBuffer) value = mixedToBuffer(value);\n    setImmediate(function () {\n      callback(null, key, value);\n    });\n  } else if (this._completed) {\n    setImmediate(callback);\n  } else {\n    this._callback = callback;\n  }\n};\n\nIterator.prototype._end = function (callback) {\n  if (this._aborted || this._completed) {\n    var err = this._error;\n    setImmediate(function () {\n      callback(err);\n    });\n    return;\n  } // Don't advance the cursor anymore, and the transaction will complete\n  // on its own in the next tick. This approach is much cleaner than calling\n  // transaction.abort() with its unpredictable event order.\n\n\n  this.onItem = noop;\n  this.onAbort = callback;\n  this.onComplete = callback;\n};","map":{"version":3,"names":["inherits","require","AbstractIterator","ltgt","mixedToBuffer","setImmediate","noop","module","exports","Iterator","db","location","options","call","_limit","limit","_count","_callback","_cache","_completed","_aborted","_error","_transaction","_keyAsBuffer","keyAsBuffer","_valueAsBuffer","valueAsBuffer","keyRange","createKeyRange","e","createIterator","reverse","prototype","lower","lowerBound","upper","upperBound","lowerOpen","lowerBoundExclusive","upperOpen","upperBoundExclusive","undefined","IDBKeyRange","bound","self","transaction","store","objectStore","req","openCursor","onsuccess","ev","cursor","target","result","onItem","onabort","onAbort","error","Error","oncomplete","onComplete","push","key","value","maybeNext","err","_next","callback","length","shift","_end"],"sources":["C:/Users/zajan/GitHub/chatApplication/node_modules/orbit-db-keystore/node_modules/level-js/iterator.js"],"sourcesContent":["/* global IDBKeyRange */\n\n'use strict'\n\nvar inherits = require('inherits')\nvar AbstractIterator = require('abstract-leveldown').AbstractIterator\nvar ltgt = require('ltgt')\nvar mixedToBuffer = require('./util/mixed-to-buffer')\nvar setImmediate = require('./util/immediate')\nvar noop = function () {}\n\nmodule.exports = Iterator\n\nfunction Iterator (db, location, options) {\n  AbstractIterator.call(this, db)\n\n  this._limit = options.limit\n  this._count = 0\n  this._callback = null\n  this._cache = []\n  this._completed = false\n  this._aborted = false\n  this._error = null\n  this._transaction = null\n\n  this._keyAsBuffer = options.keyAsBuffer\n  this._valueAsBuffer = options.valueAsBuffer\n\n  if (this._limit === 0) {\n    this._completed = true\n    return\n  }\n\n  try {\n    var keyRange = this.createKeyRange(options)\n  } catch (e) {\n    // The lower key is greater than the upper key.\n    // IndexedDB throws an error, but we'll just return 0 results.\n    this._completed = true\n    return\n  }\n\n  this.createIterator(location, keyRange, options.reverse)\n}\n\ninherits(Iterator, AbstractIterator)\n\nIterator.prototype.createKeyRange = function (options) {\n  var lower = ltgt.lowerBound(options)\n  var upper = ltgt.upperBound(options)\n  var lowerOpen = ltgt.lowerBoundExclusive(options)\n  var upperOpen = ltgt.upperBoundExclusive(options)\n\n  if (lower !== undefined && upper !== undefined) {\n    return IDBKeyRange.bound(lower, upper, lowerOpen, upperOpen)\n  } else if (lower !== undefined) {\n    return IDBKeyRange.lowerBound(lower, lowerOpen)\n  } else if (upper !== undefined) {\n    return IDBKeyRange.upperBound(upper, upperOpen)\n  } else {\n    return null\n  }\n}\n\nIterator.prototype.createIterator = function (location, keyRange, reverse) {\n  var self = this\n  var transaction = this.db.db.transaction([location], 'readonly')\n  var store = transaction.objectStore(location)\n  var req = store.openCursor(keyRange, reverse ? 'prev' : 'next')\n\n  req.onsuccess = function (ev) {\n    var cursor = ev.target.result\n    if (cursor) self.onItem(cursor)\n  }\n\n  this._transaction = transaction\n\n  // If an error occurs (on the request), the transaction will abort.\n  transaction.onabort = function () {\n    self.onAbort(self._transaction.error || new Error('aborted by user'))\n  }\n\n  transaction.oncomplete = function () {\n    self.onComplete()\n  }\n}\n\nIterator.prototype.onItem = function (cursor) {\n  this._cache.push(cursor.key, cursor.value)\n\n  if (this._limit <= 0 || ++this._count < this._limit) {\n    cursor['continue']()\n  }\n\n  this.maybeNext()\n}\n\nIterator.prototype.onAbort = function (err) {\n  this._aborted = true\n  this._error = err\n  this.maybeNext()\n}\n\nIterator.prototype.onComplete = function () {\n  this._completed = true\n  this.maybeNext()\n}\n\nIterator.prototype.maybeNext = function () {\n  if (this._callback) {\n    this._next(this._callback)\n    this._callback = null\n  }\n}\n\nIterator.prototype._next = function (callback) {\n  if (this._aborted) {\n    // The error should be picked up by either next() or end().\n    var err = this._error\n    this._error = null\n\n    setImmediate(function () {\n      callback(err)\n    })\n  } else if (this._cache.length > 0) {\n    var key = this._cache.shift()\n    var value = this._cache.shift()\n\n    if (this._keyAsBuffer) key = mixedToBuffer(key)\n    if (this._valueAsBuffer) value = mixedToBuffer(value)\n\n    setImmediate(function () {\n      callback(null, key, value)\n    })\n  } else if (this._completed) {\n    setImmediate(callback)\n  } else {\n    this._callback = callback\n  }\n}\n\nIterator.prototype._end = function (callback) {\n  if (this._aborted || this._completed) {\n    var err = this._error\n\n    setImmediate(function () {\n      callback(err)\n    })\n\n    return\n  }\n\n  // Don't advance the cursor anymore, and the transaction will complete\n  // on its own in the next tick. This approach is much cleaner than calling\n  // transaction.abort() with its unpredictable event order.\n  this.onItem = noop\n  this.onAbort = callback\n  this.onComplete = callback\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}