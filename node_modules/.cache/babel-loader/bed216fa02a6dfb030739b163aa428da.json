{"ast":null,"code":"import { makeAutoObservable, runInAction, toJS } from \"mobx\";\nexport class RoomStore {\n  constructor(rootStore) {\n    this.rootStore = rootStore;\n    this.chatRoomMessages = [];\n    makeAutoObservable(this);\n  }\n\n  async init() {\n    if (this.rootStore.dataStore.ipfsNode === undefined) throw Error(\"IPFS Node not defined!\");\n    if (this.rootStore.dataStore.orbitDb === undefined) throw Error(\"OrbitDb not defined!\");\n    runInAction(async () => {\n      this.room = await this.rootStore.dataStore.ipfsNode.pubsub;\n      this.chatRoomMessagesDb = await this.rootStore.dataStore.orbitDb.feed(\"messages\");\n      await this.chatRoomMessagesDb.load();\n      await this.setMessagesFromDb();\n      await this.connectToChatRoom(\"TestChatRoom\");\n    });\n  }\n\n  isChatRoomReady() {\n    return !!this.room;\n  }\n\n  async setMessagesFromDb() {\n    const entries = [];\n    const all = await toJS(this.chatRoomMessagesDb.all);\n    all.map(e => entries.push(e.payload.value));\n    runInAction(() => {\n      this.chatRoomMessages = entries;\n    });\n  }\n\n  echo(msg) {\n    console.log(typeof msg.data); //TODO: nevim proc ale kdyz je to zprava odeslana ze stejneho peeru tak je to string a jinak je to object\n\n    if (typeof msg.data === \"object\") msg.data = new TextDecoder().decode(msg.data);\n    console.log(msg.data);\n  }\n\n  async connectToChatRoom(chatRoomName) {\n    runInAction(async () => {\n      await this.room.subscribe(chatRoomName, this.echo);\n    });\n  } // async handleReceivingMessages(msg) {\n  //   runInAction(() => {\n  //     this.chatRoomMessagesDb.add({ message: msg });\n  //     console.log(this.chatRoomMessagesDb.all);\n  //     this.chatRoomMessages.push(msg);\n  //     console.log(msg);\n  //   });\n  // }\n\n\n  async sendMessageToChatRoom(chatRoomName, message) {\n    runInAction(async () => {\n      await this.room.publish(chatRoomName, message);\n    });\n  }\n\n}","map":{"version":3,"names":["makeAutoObservable","runInAction","toJS","RoomStore","constructor","rootStore","chatRoomMessages","init","dataStore","ipfsNode","undefined","Error","orbitDb","room","pubsub","chatRoomMessagesDb","feed","load","setMessagesFromDb","connectToChatRoom","isChatRoomReady","entries","all","map","e","push","payload","value","echo","msg","console","log","data","TextDecoder","decode","chatRoomName","subscribe","sendMessageToChatRoom","message","publish"],"sources":["C:/Users/zajan/GitHub/chatApplication/src/data/store/RoomStore.js"],"sourcesContent":["import { makeAutoObservable, runInAction, toJS } from \"mobx\";\r\n\r\nexport class RoomStore {\r\n  chatRoomMessages;\r\n  chatRoomMessagesDb;\r\n  constructor(rootStore) {\r\n    this.rootStore = rootStore;\r\n    this.chatRoomMessages = [];\r\n    makeAutoObservable(this);\r\n  }\r\n\r\n  async init() {\r\n    if (this.rootStore.dataStore.ipfsNode === undefined) throw Error(\"IPFS Node not defined!\");\r\n    if (this.rootStore.dataStore.orbitDb === undefined) throw Error(\"OrbitDb not defined!\");\r\n\r\n    runInAction(async () => {\r\n      this.room = await this.rootStore.dataStore.ipfsNode.pubsub;\r\n      this.chatRoomMessagesDb = await this.rootStore.dataStore.orbitDb.feed(\"messages\");\r\n      await this.chatRoomMessagesDb.load();\r\n      await this.setMessagesFromDb();\r\n      await this.connectToChatRoom(\"TestChatRoom\");\r\n    });\r\n  }\r\n  isChatRoomReady() {\r\n    return !!this.room;\r\n  }\r\n  async setMessagesFromDb() {\r\n    const entries = [];\r\n    const all = await toJS(this.chatRoomMessagesDb.all);\r\n    all.map((e) => entries.push(e.payload.value));\r\n    runInAction(() => {\r\n      this.chatRoomMessages = entries;\r\n    });\r\n  }\r\n  echo(msg) {\r\n    console.log(typeof msg.data);\r\n    //TODO: nevim proc ale kdyz je to zprava odeslana ze stejneho peeru tak je to string a jinak je to object\r\n    if (typeof msg.data === \"object\") msg.data = new TextDecoder().decode(msg.data);\r\n\r\n    console.log(msg.data);\r\n  }\r\n\r\n  async connectToChatRoom(chatRoomName) {\r\n    runInAction(async () => {\r\n      await this.room.subscribe(chatRoomName, this.echo);\r\n    });\r\n  }\r\n\r\n  // async handleReceivingMessages(msg) {\r\n  //   runInAction(() => {\r\n  //     this.chatRoomMessagesDb.add({ message: msg });\r\n  //     console.log(this.chatRoomMessagesDb.all);\r\n  //     this.chatRoomMessages.push(msg);\r\n  //     console.log(msg);\r\n  //   });\r\n  // }\r\n  async sendMessageToChatRoom(chatRoomName, message) {\r\n    runInAction(async () => {\r\n      await this.room.publish(chatRoomName, message);\r\n    });\r\n  }\r\n}\r\n"],"mappings":"AAAA,SAASA,kBAAT,EAA6BC,WAA7B,EAA0CC,IAA1C,QAAsD,MAAtD;AAEA,OAAO,MAAMC,SAAN,CAAgB;EAGrBC,WAAW,CAACC,SAAD,EAAY;IACrB,KAAKA,SAAL,GAAiBA,SAAjB;IACA,KAAKC,gBAAL,GAAwB,EAAxB;IACAN,kBAAkB,CAAC,IAAD,CAAlB;EACD;;EAES,MAAJO,IAAI,GAAG;IACX,IAAI,KAAKF,SAAL,CAAeG,SAAf,CAAyBC,QAAzB,KAAsCC,SAA1C,EAAqD,MAAMC,KAAK,CAAC,wBAAD,CAAX;IACrD,IAAI,KAAKN,SAAL,CAAeG,SAAf,CAAyBI,OAAzB,KAAqCF,SAAzC,EAAoD,MAAMC,KAAK,CAAC,sBAAD,CAAX;IAEpDV,WAAW,CAAC,YAAY;MACtB,KAAKY,IAAL,GAAY,MAAM,KAAKR,SAAL,CAAeG,SAAf,CAAyBC,QAAzB,CAAkCK,MAApD;MACA,KAAKC,kBAAL,GAA0B,MAAM,KAAKV,SAAL,CAAeG,SAAf,CAAyBI,OAAzB,CAAiCI,IAAjC,CAAsC,UAAtC,CAAhC;MACA,MAAM,KAAKD,kBAAL,CAAwBE,IAAxB,EAAN;MACA,MAAM,KAAKC,iBAAL,EAAN;MACA,MAAM,KAAKC,iBAAL,CAAuB,cAAvB,CAAN;IACD,CANU,CAAX;EAOD;;EACDC,eAAe,GAAG;IAChB,OAAO,CAAC,CAAC,KAAKP,IAAd;EACD;;EACsB,MAAjBK,iBAAiB,GAAG;IACxB,MAAMG,OAAO,GAAG,EAAhB;IACA,MAAMC,GAAG,GAAG,MAAMpB,IAAI,CAAC,KAAKa,kBAAL,CAAwBO,GAAzB,CAAtB;IACAA,GAAG,CAACC,GAAJ,CAASC,CAAD,IAAOH,OAAO,CAACI,IAAR,CAAaD,CAAC,CAACE,OAAF,CAAUC,KAAvB,CAAf;IACA1B,WAAW,CAAC,MAAM;MAChB,KAAKK,gBAAL,GAAwBe,OAAxB;IACD,CAFU,CAAX;EAGD;;EACDO,IAAI,CAACC,GAAD,EAAM;IACRC,OAAO,CAACC,GAAR,CAAY,OAAOF,GAAG,CAACG,IAAvB,EADQ,CAER;;IACA,IAAI,OAAOH,GAAG,CAACG,IAAX,KAAoB,QAAxB,EAAkCH,GAAG,CAACG,IAAJ,GAAW,IAAIC,WAAJ,GAAkBC,MAAlB,CAAyBL,GAAG,CAACG,IAA7B,CAAX;IAElCF,OAAO,CAACC,GAAR,CAAYF,GAAG,CAACG,IAAhB;EACD;;EAEsB,MAAjBb,iBAAiB,CAACgB,YAAD,EAAe;IACpClC,WAAW,CAAC,YAAY;MACtB,MAAM,KAAKY,IAAL,CAAUuB,SAAV,CAAoBD,YAApB,EAAkC,KAAKP,IAAvC,CAAN;IACD,CAFU,CAAX;EAGD,CA5CoB,CA8CrB;EACA;EACA;EACA;EACA;EACA;EACA;EACA;;;EAC2B,MAArBS,qBAAqB,CAACF,YAAD,EAAeG,OAAf,EAAwB;IACjDrC,WAAW,CAAC,YAAY;MACtB,MAAM,KAAKY,IAAL,CAAU0B,OAAV,CAAkBJ,YAAlB,EAAgCG,OAAhC,CAAN;IACD,CAFU,CAAX;EAGD;;AA1DoB"},"metadata":{},"sourceType":"module"}