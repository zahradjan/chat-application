{"ast":null,"code":"import { get, makeAutoObservable, runInAction, toJS } from \"mobx\";\nimport { Message } from \"./Message.js\";\nimport { AvatarGenerator } from \"random-avatar-generator\";\nimport { v4 as uuidv4 } from \"uuid\";\nexport class ChatRoom {\n  constructor(ipfsNode, pubsub, orbitDb, roomName) {\n    this.roomId = uuidv4();\n    this.ipfsNode = ipfsNode;\n    this.pubsub = pubsub;\n    this.orbitDb = orbitDb;\n    this.roomName = roomName;\n    this.textDecoder = new TextDecoder();\n    this.chatRoomMessages = [];\n    makeAutoObservable(this);\n  }\n\n  async init() {\n    await this.connectToChatRoom();\n    await this.loadMsgDb();\n    await this.setMessagesFromDb();\n  }\n\n  async loadMsgDb() {\n    this.chatMessagesDb = await this.orbitDb.feed(`${this.roomName}-messages`);\n    await this.chatMessagesDb.load();\n  }\n\n  async setMessagesFromDb() {\n    const all = await toJS(this.chatMessagesDb.all);\n    runInAction(() => {\n      all.map(e => {\n        console.log(e.payload.value);\n        return this.chatRoomMessages.push(e.payload.value);\n      });\n    });\n  }\n\n  async connectToChatRoom() {\n    runInAction(async () => {\n      // await this.pubsub.unsubscribe(this.roomName, (msg) => console.log(msg));\n      await this.pubsub.subscribe(this.roomName, await this.echo.bind(this));\n    });\n  }\n\n  async sendMessageToChatRoom(msg) {\n    console.log(\"Msg in sending: \" + msg); //TODO:messages here\n    // const date = new Date(Date.now());\n    // const message = new Message(msg.from, msg, `${date.getHours()}:${date.getMinutes()}`, new AvatarGenerator().generateRandomAvatar(msg.from));\n\n    const stringifyMessage = JSON.stringify(msg);\n    runInAction(async () => {\n      await this.pubsub.publish(this.roomName, stringifyMessage);\n    });\n  }\n\n  async uploadFile(filesContent) {\n    //TODO: maybe Multiple files if interested\n    console.log(filesContent[0]);\n    console.log(filesContent[0].name.split(\".\").pop());\n    const result = await this.ipfsNode.add(filesContent[0]);\n    console.log(result);\n    const fileMessage = {\n      fileName: filesContent[0].name,\n      path: result.path\n    };\n    console.log(fileMessage);\n    this.sendMessageToChatRoom(fileMessage);\n  }\n\n  getFileExtension(fileName) {\n    return fileName.split(\".\").pop();\n  }\n\n  fileIsImage(fileName) {\n    const match = fileName.match(/\\.(jpg|jpeg|png|gif)$/i);\n    console.log(match);\n    return match !== null;\n  }\n\n  async retrieveFileFromIpfs(path) {\n    const ipfsFile = await this.ipfsNode.cat(path);\n    console.log(ipfsFile);\n    let file;\n    const content = [];\n\n    for await (const chunk of ipfsFile) {\n      content.push(chunk);\n    }\n\n    console.log(content);\n    const blob = new Blob(content); //TODO: lepsi ukladat Blob protoze ty URL budou temporary\n\n    file = URL.createObjectURL(blob);\n    return file;\n  }\n\n  async echo(msg) {\n    // console.log(typeof msg.data);\n    console.log(msg.data); //TODO: nevim proc ale kdyz je to zprava odeslana ze stejneho peeru tak je to string a jinak je to object\n\n    if (typeof msg.data === \"object\") msg.data = this.textDecoder.decode(msg.data);\n    const parsedMsg = JSON.parse(msg.data);\n    console.log(parsedMsg);\n\n    if (msg.data.includes(\"path\")) {\n      let file = await this.retrieveFileFromIpfs(parsedMsg.path);\n      console.log(file);\n      parsedMsg[\"file\"] = file;\n    }\n\n    console.log(parsedMsg);\n    const date = new Date(Date.now());\n    const message = new Message(msg.from, parsedMsg, `${date.getHours()}:${date.getMinutes()}`, new AvatarGenerator().generateRandomAvatar(msg.from));\n    console.log(message);\n    await this.saveMessage(message);\n  }\n\n  async saveMessage(message) {\n    runInAction(async () => {\n      this.chatRoomMessages.push(message);\n      await this.chatMessagesDb.add(message);\n    });\n  }\n\n}","map":{"version":3,"names":["get","makeAutoObservable","runInAction","toJS","Message","AvatarGenerator","v4","uuidv4","ChatRoom","constructor","ipfsNode","pubsub","orbitDb","roomName","roomId","textDecoder","TextDecoder","chatRoomMessages","init","connectToChatRoom","loadMsgDb","setMessagesFromDb","chatMessagesDb","feed","load","all","map","e","console","log","payload","value","push","subscribe","echo","bind","sendMessageToChatRoom","msg","stringifyMessage","JSON","stringify","publish","uploadFile","filesContent","name","split","pop","result","add","fileMessage","fileName","path","getFileExtension","fileIsImage","match","retrieveFileFromIpfs","ipfsFile","cat","file","content","chunk","blob","Blob","URL","createObjectURL","data","decode","parsedMsg","parse","includes","date","Date","now","message","from","getHours","getMinutes","generateRandomAvatar","saveMessage"],"sources":["C:/Users/zajan/GitHub/chatApplication/src/data/models/Room.js"],"sourcesContent":["import { get, makeAutoObservable, runInAction, toJS } from \"mobx\";\r\nimport { Message } from \"./Message.js\";\r\nimport { AvatarGenerator } from \"random-avatar-generator\";\r\nimport { v4 as uuidv4 } from \"uuid\";\r\nexport class ChatRoom {\r\n  roomId;\r\n  pubsub;\r\n  ipfsNode;\r\n  orbitDb;\r\n  roomName;\r\n  textDecoder;\r\n  chatMessagesDb;\r\n  chatRoomMessages;\r\n\r\n  constructor(ipfsNode, pubsub, orbitDb, roomName) {\r\n    this.roomId = uuidv4();\r\n    this.ipfsNode = ipfsNode;\r\n    this.pubsub = pubsub;\r\n    this.orbitDb = orbitDb;\r\n    this.roomName = roomName;\r\n    this.textDecoder = new TextDecoder();\r\n\r\n    this.chatRoomMessages = [];\r\n    makeAutoObservable(this);\r\n  }\r\n  async init() {\r\n    await this.connectToChatRoom();\r\n    await this.loadMsgDb();\r\n    await this.setMessagesFromDb();\r\n  }\r\n\r\n  async loadMsgDb() {\r\n    this.chatMessagesDb = await this.orbitDb.feed(`${this.roomName}-messages`);\r\n    await this.chatMessagesDb.load();\r\n  }\r\n\r\n  async setMessagesFromDb() {\r\n    const all = await toJS(this.chatMessagesDb.all);\r\n    runInAction(() => {\r\n      all.map((e) => {\r\n        console.log(e.payload.value);\r\n        return this.chatRoomMessages.push(e.payload.value);\r\n      });\r\n    });\r\n  }\r\n\r\n  async connectToChatRoom() {\r\n    runInAction(async () => {\r\n      // await this.pubsub.unsubscribe(this.roomName, (msg) => console.log(msg));\r\n      await this.pubsub.subscribe(this.roomName, await this.echo.bind(this));\r\n    });\r\n  }\r\n\r\n  async sendMessageToChatRoom(msg) {\r\n    console.log(\"Msg in sending: \" + msg);\r\n    //TODO:messages here\r\n    // const date = new Date(Date.now());\r\n    // const message = new Message(msg.from, msg, `${date.getHours()}:${date.getMinutes()}`, new AvatarGenerator().generateRandomAvatar(msg.from));\r\n    const stringifyMessage = JSON.stringify(msg);\r\n    runInAction(async () => {\r\n      await this.pubsub.publish(this.roomName, stringifyMessage);\r\n    });\r\n  }\r\n\r\n  async uploadFile(filesContent) {\r\n    //TODO: maybe Multiple files if interested\r\n    console.log(filesContent[0]);\r\n    console.log(filesContent[0].name.split(\".\").pop());\r\n    const result = await this.ipfsNode.add(filesContent[0]);\r\n    console.log(result);\r\n    const fileMessage = { fileName: filesContent[0].name, path: result.path };\r\n    console.log(fileMessage);\r\n    this.sendMessageToChatRoom(fileMessage);\r\n  }\r\n  getFileExtension(fileName) {\r\n    return fileName.split(\".\").pop();\r\n  }\r\n\r\n  fileIsImage(fileName) {\r\n    const match = fileName.match(/\\.(jpg|jpeg|png|gif)$/i);\r\n    console.log(match);\r\n    return match !== null;\r\n  }\r\n  async retrieveFileFromIpfs(path) {\r\n    const ipfsFile = await this.ipfsNode.cat(path);\r\n\r\n    console.log(ipfsFile);\r\n\r\n    let file;\r\n\r\n    const content = [];\r\n    for await (const chunk of ipfsFile) {\r\n      content.push(chunk);\r\n    }\r\n    console.log(content);\r\n\r\n    const blob = new Blob(content);\r\n    //TODO: lepsi ukladat Blob protoze ty URL budou temporary\r\n    file = URL.createObjectURL(blob);\r\n\r\n    return file;\r\n  }\r\n\r\n  async echo(msg) {\r\n    // console.log(typeof msg.data);\r\n    console.log(msg.data);\r\n    //TODO: nevim proc ale kdyz je to zprava odeslana ze stejneho peeru tak je to string a jinak je to object\r\n    if (typeof msg.data === \"object\") msg.data = this.textDecoder.decode(msg.data);\r\n    const parsedMsg = JSON.parse(msg.data);\r\n    console.log(parsedMsg);\r\n    if (msg.data.includes(\"path\")) {\r\n      let file = await this.retrieveFileFromIpfs(parsedMsg.path);\r\n      console.log(file);\r\n      parsedMsg[\"file\"] = file;\r\n    }\r\n    console.log(parsedMsg);\r\n    const date = new Date(Date.now());\r\n    const message = new Message(msg.from, parsedMsg, `${date.getHours()}:${date.getMinutes()}`, new AvatarGenerator().generateRandomAvatar(msg.from));\r\n\r\n    console.log(message);\r\n\r\n    await this.saveMessage(message);\r\n  }\r\n\r\n  async saveMessage(message) {\r\n    runInAction(async () => {\r\n      this.chatRoomMessages.push(message);\r\n      await this.chatMessagesDb.add(message);\r\n    });\r\n  }\r\n}\r\n"],"mappings":"AAAA,SAASA,GAAT,EAAcC,kBAAd,EAAkCC,WAAlC,EAA+CC,IAA/C,QAA2D,MAA3D;AACA,SAASC,OAAT,QAAwB,cAAxB;AACA,SAASC,eAAT,QAAgC,yBAAhC;AACA,SAASC,EAAE,IAAIC,MAAf,QAA6B,MAA7B;AACA,OAAO,MAAMC,QAAN,CAAe;EAUpBC,WAAW,CAACC,QAAD,EAAWC,MAAX,EAAmBC,OAAnB,EAA4BC,QAA5B,EAAsC;IAC/C,KAAKC,MAAL,GAAcP,MAAM,EAApB;IACA,KAAKG,QAAL,GAAgBA,QAAhB;IACA,KAAKC,MAAL,GAAcA,MAAd;IACA,KAAKC,OAAL,GAAeA,OAAf;IACA,KAAKC,QAAL,GAAgBA,QAAhB;IACA,KAAKE,WAAL,GAAmB,IAAIC,WAAJ,EAAnB;IAEA,KAAKC,gBAAL,GAAwB,EAAxB;IACAhB,kBAAkB,CAAC,IAAD,CAAlB;EACD;;EACS,MAAJiB,IAAI,GAAG;IACX,MAAM,KAAKC,iBAAL,EAAN;IACA,MAAM,KAAKC,SAAL,EAAN;IACA,MAAM,KAAKC,iBAAL,EAAN;EACD;;EAEc,MAATD,SAAS,GAAG;IAChB,KAAKE,cAAL,GAAsB,MAAM,KAAKV,OAAL,CAAaW,IAAb,CAAmB,GAAE,KAAKV,QAAS,WAAnC,CAA5B;IACA,MAAM,KAAKS,cAAL,CAAoBE,IAApB,EAAN;EACD;;EAEsB,MAAjBH,iBAAiB,GAAG;IACxB,MAAMI,GAAG,GAAG,MAAMtB,IAAI,CAAC,KAAKmB,cAAL,CAAoBG,GAArB,CAAtB;IACAvB,WAAW,CAAC,MAAM;MAChBuB,GAAG,CAACC,GAAJ,CAASC,CAAD,IAAO;QACbC,OAAO,CAACC,GAAR,CAAYF,CAAC,CAACG,OAAF,CAAUC,KAAtB;QACA,OAAO,KAAKd,gBAAL,CAAsBe,IAAtB,CAA2BL,CAAC,CAACG,OAAF,CAAUC,KAArC,CAAP;MACD,CAHD;IAID,CALU,CAAX;EAMD;;EAEsB,MAAjBZ,iBAAiB,GAAG;IACxBjB,WAAW,CAAC,YAAY;MACtB;MACA,MAAM,KAAKS,MAAL,CAAYsB,SAAZ,CAAsB,KAAKpB,QAA3B,EAAqC,MAAM,KAAKqB,IAAL,CAAUC,IAAV,CAAe,IAAf,CAA3C,CAAN;IACD,CAHU,CAAX;EAID;;EAE0B,MAArBC,qBAAqB,CAACC,GAAD,EAAM;IAC/BT,OAAO,CAACC,GAAR,CAAY,qBAAqBQ,GAAjC,EAD+B,CAE/B;IACA;IACA;;IACA,MAAMC,gBAAgB,GAAGC,IAAI,CAACC,SAAL,CAAeH,GAAf,CAAzB;IACAnC,WAAW,CAAC,YAAY;MACtB,MAAM,KAAKS,MAAL,CAAY8B,OAAZ,CAAoB,KAAK5B,QAAzB,EAAmCyB,gBAAnC,CAAN;IACD,CAFU,CAAX;EAGD;;EAEe,MAAVI,UAAU,CAACC,YAAD,EAAe;IAC7B;IACAf,OAAO,CAACC,GAAR,CAAYc,YAAY,CAAC,CAAD,CAAxB;IACAf,OAAO,CAACC,GAAR,CAAYc,YAAY,CAAC,CAAD,CAAZ,CAAgBC,IAAhB,CAAqBC,KAArB,CAA2B,GAA3B,EAAgCC,GAAhC,EAAZ;IACA,MAAMC,MAAM,GAAG,MAAM,KAAKrC,QAAL,CAAcsC,GAAd,CAAkBL,YAAY,CAAC,CAAD,CAA9B,CAArB;IACAf,OAAO,CAACC,GAAR,CAAYkB,MAAZ;IACA,MAAME,WAAW,GAAG;MAAEC,QAAQ,EAAEP,YAAY,CAAC,CAAD,CAAZ,CAAgBC,IAA5B;MAAkCO,IAAI,EAAEJ,MAAM,CAACI;IAA/C,CAApB;IACAvB,OAAO,CAACC,GAAR,CAAYoB,WAAZ;IACA,KAAKb,qBAAL,CAA2Ba,WAA3B;EACD;;EACDG,gBAAgB,CAACF,QAAD,EAAW;IACzB,OAAOA,QAAQ,CAACL,KAAT,CAAe,GAAf,EAAoBC,GAApB,EAAP;EACD;;EAEDO,WAAW,CAACH,QAAD,EAAW;IACpB,MAAMI,KAAK,GAAGJ,QAAQ,CAACI,KAAT,CAAe,wBAAf,CAAd;IACA1B,OAAO,CAACC,GAAR,CAAYyB,KAAZ;IACA,OAAOA,KAAK,KAAK,IAAjB;EACD;;EACyB,MAApBC,oBAAoB,CAACJ,IAAD,EAAO;IAC/B,MAAMK,QAAQ,GAAG,MAAM,KAAK9C,QAAL,CAAc+C,GAAd,CAAkBN,IAAlB,CAAvB;IAEAvB,OAAO,CAACC,GAAR,CAAY2B,QAAZ;IAEA,IAAIE,IAAJ;IAEA,MAAMC,OAAO,GAAG,EAAhB;;IACA,WAAW,MAAMC,KAAjB,IAA0BJ,QAA1B,EAAoC;MAClCG,OAAO,CAAC3B,IAAR,CAAa4B,KAAb;IACD;;IACDhC,OAAO,CAACC,GAAR,CAAY8B,OAAZ;IAEA,MAAME,IAAI,GAAG,IAAIC,IAAJ,CAASH,OAAT,CAAb,CAb+B,CAc/B;;IACAD,IAAI,GAAGK,GAAG,CAACC,eAAJ,CAAoBH,IAApB,CAAP;IAEA,OAAOH,IAAP;EACD;;EAES,MAAJxB,IAAI,CAACG,GAAD,EAAM;IACd;IACAT,OAAO,CAACC,GAAR,CAAYQ,GAAG,CAAC4B,IAAhB,EAFc,CAGd;;IACA,IAAI,OAAO5B,GAAG,CAAC4B,IAAX,KAAoB,QAAxB,EAAkC5B,GAAG,CAAC4B,IAAJ,GAAW,KAAKlD,WAAL,CAAiBmD,MAAjB,CAAwB7B,GAAG,CAAC4B,IAA5B,CAAX;IAClC,MAAME,SAAS,GAAG5B,IAAI,CAAC6B,KAAL,CAAW/B,GAAG,CAAC4B,IAAf,CAAlB;IACArC,OAAO,CAACC,GAAR,CAAYsC,SAAZ;;IACA,IAAI9B,GAAG,CAAC4B,IAAJ,CAASI,QAAT,CAAkB,MAAlB,CAAJ,EAA+B;MAC7B,IAAIX,IAAI,GAAG,MAAM,KAAKH,oBAAL,CAA0BY,SAAS,CAAChB,IAApC,CAAjB;MACAvB,OAAO,CAACC,GAAR,CAAY6B,IAAZ;MACAS,SAAS,CAAC,MAAD,CAAT,GAAoBT,IAApB;IACD;;IACD9B,OAAO,CAACC,GAAR,CAAYsC,SAAZ;IACA,MAAMG,IAAI,GAAG,IAAIC,IAAJ,CAASA,IAAI,CAACC,GAAL,EAAT,CAAb;IACA,MAAMC,OAAO,GAAG,IAAIrE,OAAJ,CAAYiC,GAAG,CAACqC,IAAhB,EAAsBP,SAAtB,EAAkC,GAAEG,IAAI,CAACK,QAAL,EAAgB,IAAGL,IAAI,CAACM,UAAL,EAAkB,EAAzE,EAA4E,IAAIvE,eAAJ,GAAsBwE,oBAAtB,CAA2CxC,GAAG,CAACqC,IAA/C,CAA5E,CAAhB;IAEA9C,OAAO,CAACC,GAAR,CAAY4C,OAAZ;IAEA,MAAM,KAAKK,WAAL,CAAiBL,OAAjB,CAAN;EACD;;EAEgB,MAAXK,WAAW,CAACL,OAAD,EAAU;IACzBvE,WAAW,CAAC,YAAY;MACtB,KAAKe,gBAAL,CAAsBe,IAAtB,CAA2ByC,OAA3B;MACA,MAAM,KAAKnD,cAAL,CAAoB0B,GAApB,CAAwByB,OAAxB,CAAN;IACD,CAHU,CAAX;EAID;;AA7HmB"},"metadata":{},"sourceType":"module"}