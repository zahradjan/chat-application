{"ast":null,"code":"import { makeAutoObservable, runInAction, toJS } from \"mobx\";\nimport { AvatarGenerator } from \"random-avatar-generator\";\nimport { Message } from \"../models/Message.js\";\nimport { ChatRoom } from \"../models/Room.js\";\nexport class RoomStore {\n  //TODO: avatar temporary dont forget to refactor this\n  constructor(rootStore) {\n    this.rootStore = rootStore;\n    this.rooms = [];\n    this.textDecoder = new TextDecoder();\n    this.avatar = new AvatarGenerator();\n    makeAutoObservable(this);\n  }\n\n  async init() {\n    if (this.rootStore.dataStore.ipfsNode === undefined) throw Error(\"IPFS Node not defined!\");\n    if (this.rootStore.dataStore.orbitDb === undefined) throw Error(\"OrbitDb not defined!\"); // runInAction(async () => {\n    //   this.room = await this.rootStore.dataStore.ipfsNode.pubsub;\n    //   this.chatRoomMessagesDb = await this.rootStore.dataStore.orbitDb.feed(\"messages\");\n    //   await this.chatRoomMessagesDb.load();\n    //   await this.setMessagesFromDb();\n    //   await this.connectToChatRoom(\"TestChatRoom\");\n    // });\n  }\n\n  createRoom(roomName) {\n    if (this.rootStore.dataStore.ipfsNode === undefined) throw Error(\"IPFS Node not defined!\");\n    if (this.rootStore.dataStore.orbitDb === undefined) throw Error(\"OrbitDb not defined!\");\n    const chatRoom = new ChatRoom(this.rootStore.dataStore.ipsNode.pubsub, roomName);\n    this.rooms.push(chatRoom);\n    return chatRoom;\n  }\n\n  getRoom(roomName) {\n    return this.rooms.find(room => roomName = room.roomName);\n  }\n\n  isChatRoomReady() {\n    return !!this.room;\n  }\n\n  async setMessagesFromDb() {\n    const entries = [];\n    const all = await toJS(this.chatRoomMessagesDb.all);\n    all.map(e => entries.push(e.payload.value));\n    runInAction(() => {\n      this.chatRoomMessages = entries;\n    });\n  }\n\n  async echo(msg) {\n    console.log(typeof msg.data);\n    console.log(msg); //TODO: nevim proc ale kdyz je to zprava odeslana ze stejneho peeru tak je to string a jinak je to object\n\n    if (typeof msg.data === \"object\") msg.data = this.textDecoder.decode(msg.data);\n    const date = new Date(Date.now());\n    const message = new Message(msg.from, msg.data, `${date.getHours()}:${date.getMinutes()}`, this.avatar.generateRandomAvatar(msg.from));\n    console.log(message);\n    this.chatRoomMessagesDb.add(message);\n    this.chatRoomMessages.push(message);\n  }\n\n  async connectToChatRoom(chatRoomName) {\n    runInAction(async () => {\n      await this.room.subscribe(chatRoomName, await this.echo.bind(this));\n    });\n  }\n\n  async sendMessageToChatRoom(chatRoomName, message) {\n    runInAction(async () => {\n      await this.room.publish(chatRoomName, message);\n    });\n  }\n\n}","map":{"version":3,"names":["makeAutoObservable","runInAction","toJS","AvatarGenerator","Message","ChatRoom","RoomStore","constructor","rootStore","rooms","textDecoder","TextDecoder","avatar","init","dataStore","ipfsNode","undefined","Error","orbitDb","createRoom","roomName","chatRoom","ipsNode","pubsub","push","getRoom","find","room","isChatRoomReady","setMessagesFromDb","entries","all","chatRoomMessagesDb","map","e","payload","value","chatRoomMessages","echo","msg","console","log","data","decode","date","Date","now","message","from","getHours","getMinutes","generateRandomAvatar","add","connectToChatRoom","chatRoomName","subscribe","bind","sendMessageToChatRoom","publish"],"sources":["C:/Users/zajan/GitHub/chatApplication/src/data/store/RoomStore.js"],"sourcesContent":["import { makeAutoObservable, runInAction, toJS } from \"mobx\";\r\nimport { AvatarGenerator } from \"random-avatar-generator\";\r\nimport { Message } from \"../models/Message.js\";\r\nimport { ChatRoom } from \"../models/Room.js\";\r\n\r\nexport class RoomStore {\r\n  //TODO: avatar temporary dont forget to refactor this\r\n  avatar;\r\n  room;\r\n  chatRoomMessages;\r\n  chatRoomMessagesDb;\r\n  textDecoder;\r\n  constructor(rootStore) {\r\n    this.rootStore = rootStore;\r\n    this.rooms = [];\r\n    this.textDecoder = new TextDecoder();\r\n    this.avatar = new AvatarGenerator();\r\n    makeAutoObservable(this);\r\n  }\r\n\r\n  async init() {\r\n    if (this.rootStore.dataStore.ipfsNode === undefined) throw Error(\"IPFS Node not defined!\");\r\n    if (this.rootStore.dataStore.orbitDb === undefined) throw Error(\"OrbitDb not defined!\");\r\n\r\n    // runInAction(async () => {\r\n    //   this.room = await this.rootStore.dataStore.ipfsNode.pubsub;\r\n    //   this.chatRoomMessagesDb = await this.rootStore.dataStore.orbitDb.feed(\"messages\");\r\n    //   await this.chatRoomMessagesDb.load();\r\n    //   await this.setMessagesFromDb();\r\n    //   await this.connectToChatRoom(\"TestChatRoom\");\r\n    // });\r\n  }\r\n\r\n  createRoom(roomName) {\r\n    if (this.rootStore.dataStore.ipfsNode === undefined) throw Error(\"IPFS Node not defined!\");\r\n    if (this.rootStore.dataStore.orbitDb === undefined) throw Error(\"OrbitDb not defined!\");\r\n    const chatRoom = new ChatRoom(this.rootStore.dataStore.ipsNode.pubsub, roomName);\r\n    this.rooms.push(chatRoom);\r\n    return chatRoom;\r\n  }\r\n\r\n  getRoom(roomName) {\r\n    return this.rooms.find((room) => (roomName = room.roomName));\r\n  }\r\n\r\n  isChatRoomReady() {\r\n    return !!this.room;\r\n  }\r\n  async setMessagesFromDb() {\r\n    const entries = [];\r\n    const all = await toJS(this.chatRoomMessagesDb.all);\r\n    all.map((e) => entries.push(e.payload.value));\r\n    runInAction(() => {\r\n      this.chatRoomMessages = entries;\r\n    });\r\n  }\r\n  async echo(msg) {\r\n    console.log(typeof msg.data);\r\n    console.log(msg);\r\n    //TODO: nevim proc ale kdyz je to zprava odeslana ze stejneho peeru tak je to string a jinak je to object\r\n    if (typeof msg.data === \"object\") msg.data = this.textDecoder.decode(msg.data);\r\n    const date = new Date(Date.now());\r\n    const message = new Message(msg.from, msg.data, `${date.getHours()}:${date.getMinutes()}`, this.avatar.generateRandomAvatar(msg.from));\r\n    console.log(message);\r\n    this.chatRoomMessagesDb.add(message);\r\n    this.chatRoomMessages.push(message);\r\n  }\r\n\r\n  async connectToChatRoom(chatRoomName) {\r\n    runInAction(async () => {\r\n      await this.room.subscribe(chatRoomName, await this.echo.bind(this));\r\n    });\r\n  }\r\n\r\n  async sendMessageToChatRoom(chatRoomName, message) {\r\n    runInAction(async () => {\r\n      await this.room.publish(chatRoomName, message);\r\n    });\r\n  }\r\n}\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}